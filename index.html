<!DOCTYPE HTML>
<html>
    <body onkeydown="KeyDown(event)" onkeyup="KeyUp(event)" onload="OnLoad()">        
        <canvas id="screen" width="400" height="300"></canvas>
        <script src="./scripts/framework/Linking.js"></script>
        <script>
        var s2p = 1/0.02;
        var objList = [];
        var right = false;
        var left = false;
        var up = false;
        var down = false;
        var hAxis = 0;
        var vAxis = 0;
        var ch = {x:0,y:0,width:1,height:1};
        var ctx;
        var gridLayer;
        var Object;
        var runninx = 0.2;
        var runninObj;
        var runniny = 0.2;
        var runninObj2;
        var runninBack = false;
        var runninBack2 = false;
        function KeyDown(e){
            switch(e.keyCode){
                case 39:
                    right = true;
                    break;
                case 37:
                    left = true;
                    break;
                case 38:
                    up = true;
                    break;
                case 40:
                    down = true;
                    break;
            }
        }
        function KeyUp(e){
            switch(e.keyCode){
                case 39:
                    right = false;
                    break;
                case 37:
                    left = false;
                    break;
                case 38:
                    up = false;
                    break;
                case 40:
                    down = false;
                    break;
            }
        }
        function Update(){
            if(up&&down)
                vAxis = 0;
            else if(up)
                vAxis = 1;
            else if (down)
                vAxis = -1;
            else
                vAxis = 0;
            if(right&&left)
                hAxis = 0;
            else if(right)
                hAxis = 1;
            else if (left)
                hAxis = -1;
            else
                hAxis = 0;
            if(Updating.deltaTime >= 0 || Updating.deltaTime < 0){
                    ch.x += hAxis * Updating.deltaTime * 4;
                    ch.y += vAxis * Updating.deltaTime * 4;
                    if(ch.x < 0)
                    ch.x = 0;
                if(ch.y < 0)
                    ch.y = 0;
                if(ch.x > 400 / s2p - ch.width)
                    ch.x = 400 / s2p - ch.width;
                if(ch.y > 300 / s2p - ch.height)
                    ch.y = 300 / s2p - ch.height;
                if(runninBack){
                    runninx -= Updating.deltaTime * 3;
                    if(runninx < 0.2){
                            runninx = 0.2;
                            runninBack = false;
                    }
                }else{
                    runninx += Updating.deltaTime * 3;
                    if(runninx > 3){
                            runninx = 3;
                            runninBack = true;
                    }
                }
                if(runninBack2){
                    runniny -= Updating.deltaTime * 3;
                    if(runniny < 0.2){
                            runniny = 0.2;
                            runninBack2 = false;
                        }
                }else{
                    runniny += Updating.deltaTime * 3;
                    if(runniny > 3){
                            runniny = 3;
                            runninBack2 = true;
                        }
                }
            }
            
            gridLayer.updateRect(runninObj.rect,runninx,runninx+1,3.6,4.1);
            gridLayer.updateRect(runninObj2.rect,5.6,6.2,runniny,runniny+1.2);
            objList.forEach(obj => {
                obj.color = "#FFFFFF";
            });
            gridLayer.overlapRect(ch.x,ch.y,ch.x + ch.width,ch.y + ch.height).forEach(rect => {
                rect.obj.color = "#FF0000";
            });
            ctx.fillStyle = "#000000";
            ctx.fillRect(0,0,400,300);
            objList.forEach(obj=>{
                ctx.fillStyle = obj.color;
                ctx.fillRect(obj.rect.left * s2p, 300 - obj.rect.bottom * s2p, (obj.rect.right - obj.rect.left) * s2p,(obj.rect.bottom - obj.rect.top) * s2p);
            });
            ctx.fillStyle = "#00FFFF";
            ctx.fillRect(ch.x * s2p,300 - ch.y * s2p,ch.width * s2p,-ch.height * s2p);
        }
        function OnLoad(){
            ctx = document.getElementById("screen").getContext("2d");
            linkFile("./scripts/framework/RectOverlap.js",theCallback);
        }
        var oldtimestamp = 0;
        function draw(timestamp){
            var dt = timestamp - oldtimestamp;
            oldtimestamp = timestamp;
            Updating.renderFrame(dt);
            requestAnimationFrame(draw);
        }
        function theCallback(){
            gridLayer = new RectOverlap.GridLayer(16,16,2,2);
            Object = function(x, y, w, h,color = "#FFFFFF"){
                this.rect = new RectOverlap.RectObj(x,y,x+w,y+h,this);
                this.color = color;
                objList.push(this);
            }
            gridLayer.addRect(new Object(1.4, 1.5, 0.5, 0.6).rect);
            gridLayer.addRect(new Object(0.2, 0.8, 2, 0.5).rect);
            gridLayer.addRect(new Object(2.5, 1.8, 1.5, 1.5).rect);
            gridLayer.addRect(new Object(4.4, 2.7, 2.5, 0.8).rect);
            runninObj = new Object(runninx, 1, 3.6, 0.5);
            runninObj2 = new Object(5.6, 0.6, runniny, 1.2);
            gridLayer.addRect(runninObj.rect);
            gridLayer.addRect(runninObj2.rect);
            linkFile("./scripts/framework/Updating.js", function(){
                console.log("lnk");
                Updating.startRenderRoutine("upd",0,Update);
                draw();
            });
        }

        </script>
    </body>
</html>
