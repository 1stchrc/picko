<!DOCTYPE HTML>
<html>
    <head>
        <style>
            body{
                margin: 0;
            }
            #screen{
                width: 100%;
                height: 100%;
                position: absolute;
            }
        </style>
    </head>
    <body onload="OnLoad()">        
        <canvas id="screen" width = "1300" height = "600"></canvas>
        <script src="./scripts/framework/Linking.js"></script>
        <script>
        var objList = [];
        var hAxis = 0;
        var vAxis = 0;
        var ch = {x:0,y:0,width:6,height:6};
        var lastChX = 0;
        var lastChY = 0;
        var ctx;
        var swidth;
        var sheight;
        var gridLayer;
        var Object;
        var mousePos;
        var sup = null;
        var sdown = null;
        var mouseButton = null;
        var oldTime = 0;
        var newTime = 0;
        var hsqrt2 = Math.sqrt(2) / 2;
        var runState = 0;
        var runTimer = 0;
        var runhTime = 4000;
        var runvTime = 2500;
        var runObj;
        function Update(){
            var up = sup.pressed;
            var down = sdown.pressed;
            var left = Input.getButton("left").pressed;
            var right = Input.getButton("right").pressed;
            lastChX = ch.x;
            lastChY = ch.y;
            if(up&&down)
                vAxis = 0;
            else if(up)
                vAxis = 1;
            else if (down)
                vAxis = -1;
            else
                vAxis = 0;
            if(right&&left)
                hAxis = 0;
            else if(right)
                hAxis = 1;
            else if (left)
                hAxis = -1;
            else
                hAxis = 0;
            if(hAxis != 0 && vAxis != 0){
                hAxis *= hsqrt2;
                vAxis *= hsqrt2;
            }
            ch.x += hAxis * 0.8;
            ch.y += vAxis * 0.8;
            if(ch.x < 0)
                ch.x = 0;
            if(ch.y < 0)
                ch.y = 0;
            if(ch.x > swidth - ch.width)
                ch.x = swidth - ch.width;
            if(ch.y > sheight - ch.height)
                ch.y = sheight - ch.height;
            objList.forEach(obj => {
                obj.lastX = obj.x;
                obj.lastY = obj.y;
                obj.color = "#FFFFFF";
            });
            if(runState == 0){
                if(runTimer > runhTime){
                    runState = 1;
                    runObj.moveTo(83, 22);
                    runTimer = 0;
                } else {
                    runObj.moveTo((1 - Math.cos(Math.PI * runTimer / runhTime)) * 70 / 2 + 13, 22);
                    runTimer += Time.fixedDeltaTime;
                }
            }else if(runState == 1){
                if(runTimer > runvTime){
                    runState = 2;
                    runObj.moveTo(83, 58);
                    runTimer = 0;
                } else {
                    runObj.moveTo(83, (1 - Math.cos(Math.PI * runTimer / runvTime)) * 36 / 2 + 22);
                    runTimer += Time.fixedDeltaTime;
                }
            }else if(runState == 2){
                if(runTimer > runhTime){
                    runState = 3;
                    runObj.moveTo(13, 58);
                    runTimer = 0;
                } else {
                    runObj.moveTo(-(1 - Math.cos(Math.PI * runTimer / runhTime)) * 70 / 2 + 83, 58);
                    runTimer += Time.fixedDeltaTime;
                }
            }else if(runState == 3){
                if(runTimer > runvTime){
                    runState = 0;
                    runObj.moveTo(13, 22);
                    runTimer = 0;
                } else {
                    runObj.moveTo(13, -(1 - Math.cos(Math.PI * runTimer / runvTime)) * 36 / 2 + 58);
                    runTimer += Time.fixedDeltaTime;
                }
            }
            var rchx = Math.round(ch.x);
            var rchy = Math.round(ch.y);
            gridLayer.overlapRect(rchx ,rchy , rchx + ch.width - 1, rchy + ch.height - 1,rect => {
                rect.obj.color = "#FF0000";
            });
            oldTime = newTime;
            newTime = Time.fixedTimestamp;
        }
        function Render(){
            var rwidth = Global.onscreenCanvas.clientWidth;
            var rheight = Global.onscreenCanvas.clientHeight;
            Global.onscreenCanvas.width = rwidth;
            Global.onscreenCanvas.height = rheight;
            Global.onscreenCanvasContext.imageSmoothingEnabled = false;
            Global.onscreenCanvasContext.fillStyle = "#0000FF";
            Global.onscreenCanvasContext.fillRect(0,0,rwidth,rheight);
            if(Global.onscreenCanvas.height / Global.onscreenCanvas.width < sheight / swidth){
                var zoom = rheight / sheight;
                Rendering.setBlitOptions((rwidth - swidth * zoom) / 2, 0, swidth * zoom, sheight * zoom);
            }else{
                var zoom = rwidth / swidth;
                Rendering.setBlitOptions(0, (rheight - sheight * zoom) / 2, swidth * zoom, sheight * zoom);
            }
        }
        function LateRender(){
            
            ctx.fillStyle = "#000000";
            ctx.fillRect(0,0,swidth,sheight);
            var chx;
            var chy;
            if(oldTime < newTime){
                var lerp = (Time.renderTimestamp - oldTime) / (newTime - oldTime);
                var lerp2 = 1 - lerp;
                chx = lastChX * lerp2 + ch.x * lerp;
                chy = lastChY * lerp2 + ch.y * lerp;
                objList.forEach(obj=>{
                    var objx = Math.round(obj.lastX * lerp2 + obj.x * lerp);
                    var objy = Math.round(obj.lastY * lerp2 + obj.y * lerp);
                    ctx.fillStyle = obj.color;
                    ctx.fillRect(objx, objy, obj.width,obj.height);
                    ctx.fillStyle = "#000000";
                    ctx.fillRect(objx + 1, objy + 1, obj.width - 2,obj.height - 2);
                });
                
            } else {
                chx = ch.x;
                chy = ch.y;
                
            }
            ctx.fillStyle = "#00FFFF";
            ctx.fillRect(Math.round(chx),Math.round(chy),ch.width,ch.height);
            ctx.fillStyle = "#000000";
            ctx.fillRect(Math.round(chx) + 1,Math.round(chy) + 1,ch.width - 2,ch.height - 2);
        }
        function OnLoad(){
            linkFile("./scripts/framework/Misc.js")
            .then(() => linkFile("./scripts/framework/Global.js"))
            .then(() => {Global.onscreenCanvas = document.getElementById("screen"); Global.onscreenCanvasContext = Global.onscreenCanvas.getContext("2d"); return linkFile("./scripts/framework/RectOverlap.js")})
            .then(() => linkFile("./scripts/framework/Updating.js"))
            .then(() => linkFile("./scripts/framework/Rendering.js"))
            .then(() => linkFile("./scripts/framework/Input.js")).then(()=>{
                ctx = Rendering.getScreenContext();
                swidth = Rendering.getScreenWidth();
                sheight = Rendering.getScreenHeight();
                function pd(e){e.preventDefault()}
                Global.onscreenCanvas.addEventListener("touchstart",pd);
                Global.onscreenCanvas.addEventListener("touchend",pd);
                Global.onscreenCanvas.addEventListener("touchcancel",pd);
                Global.onscreenCanvas.addEventListener("touchmove",pd);
                gridLayer = new RectOverlap.GridLayer(8,8,16,9);
                Object = function(x, y, w, h,color = "#FFFFFF"){
                    this.rect = new RectOverlap.RectObj(x,y,x+w-1,y+h-1,this);
                    this.x = x;
                    this.y = y;
                    this.width = w;
                    this.height = h;
                    this.color = color;
                    this.lastX = x;
                    this.lastY = y;
                    objList.push(this);
                    gridLayer.addRect(this.rect);
                };
                Object.prototype.moveTo = function(x,y){
                    this.x = x;
                    this.y = y;
                    var rx = Math.round(x);
                    var ry = Math.round(y);
                    gridLayer.updateRect(this.rect, rx, rx + this.width - 1, ry,  ry + this.height - 1);
                };
                new Object(16,5,31,15);
                new Object(100,32,15,31);
                runObj = new Object(13, 22, 10, 10);
                sup = Input.registerButton("up", "ArrowUp");
                sdown = Input.registerButton("down", "ArrowDown");
                Input.registerButton("left", "ArrowLeft");
                Input.registerButton("right", "ArrowRight");
                mousePos = Input.getMousePos();
                mouseButton = Input.getMouseButton(0);
                Updating.startRenderRoutine("rdr",0, Render);
                Updating.startLateRenderRoutine("lrdr",0, LateRender);
                Updating.startFixedRoutine("upd", 0, Update);
                draw(0);
                Updating.fixedUpdatePaused = false;
            });      
        }
        function draw(timestamp){
            try{
                Updating.renderFrame(timestamp);
            } catch(e) {
                alert(e);
                throw e;
            }
            requestAnimationFrame(draw);
        }

        </script>
    </body>
</html>
