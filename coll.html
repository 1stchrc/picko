<!DOCTYPE HTML>
<html>
    <body onkeydown="KeyDown(event)" onkeyup="KeyUp(event)" onload="OnLoad()">        
        <script type="text/javascript">
        function Rect(x,y,width,height,obj = null){
            this.x = x;
            this.y = y;
            this.width = width;
            this.height = height;
            this.master = obj;
        }
        var gridList = [];
        var gridSizeX;
        var gridSizeY;
        var gridScaleX;
        var gridScaleY;
        function SetGridListSize(x,y){
            oldLength = gridList.length;
            gridSizeX = x;
            gridSizeY = y;
            gridList.length = x*y;
            if(oldLength < gridList.length)
                for(i = oldLength; i < gridList.length;i++){
                    gridList[i] = [];
                }
        }
        function SetGridScale(x,y){
            gridScaleX = x;
            gridScaleY = y;
        }
        function GetGrid(x,y){
            return gridList[x + y * gridSizeX];
        }
        function AddRect(rect){
            xmin = Math.floor(rect.x/gridSizeX);
            xmax = Math.ceil((rect.x+rect.width)/gridScaleX)
            ymax = Math.ceil((rect.y+rect.height)/gridScaleY)
            for(var y = Math.floor(rect.y/gridScaleY); y < ymax; y++){
                for(var x = xmin; x < xmax; x++){
                    GetGrid(x,y).push(rect);
                }
            }
        }
        function RemoveRect(rect){
            xmin = Math.floor(rect.x/gridSizeX);
            xmax = Math.ceil((rect.x+rect.width)/gridScaleX)
            ymax = Math.ceil((rect.y+rect.height)/gridScaleY)
            for(var y = Math.floor(rect.y/gridScaleY); y < ymax; y++){
                for(var x = xmin; x < xmax; x++){
                    set = GetGrid(x,y);
                    set.splice(set.indexOf(rect),1);
                }
            }
        }
        function CheckRectCollision(rect){
            array = [];
            xmin = Math.floor(rect.x/gridSizeX);
            xmax = Math.ceil((rect.x+rect.width)/gridScaleX)
            ymax = Math.ceil((rect.y+rect.height)/gridScaleY)
            for(var y = Math.floor(rect.y/gridScaleY); y < ymax; y++){
                for(var x = xmin; x < xmax; x++){
                    GetGrid(x,y).forEach(r=>{
                        if(array.indexOf(rect) != -1)
                            continue;
                        if(r.x > rect.x + rect.width)
                            continue;
                        if(rect.x > r.x + r.width)
                            continue;
                        if(r.y > rect.y + rect.height)
                            continue;
                        if(rect.y > r.y + r.height)
                            continue;
                        array.push(r);
                    });
                }
            }
            return array;
        }
        </script>
        <canvas id="screen" width="400" height="300"></canvas>
        <script>
        var s2p = 1/0.02;
        var objList = [];
        var right = false;
        var left = false;
        var up = false;
        var down = false;
        var hAxis = 0;
        var vAxis = 0;
        var ch = new Rect(0,0,1,1);
        var ctx;
        function Object(x, y, w, h,color = "#FFFFFF"){
            this.rect = new Rect(x,y,w,h,this);
            this.color = color;
            objList.push(this);
        }
        function KeyDown(e){
            switch(e.keyCode){
                case 39:
                    right = true;
                    break;
                case 37:
                    left = true;
                    break;
                case 38:
                    up = true;
                    break;
                case 40:
                    down = true;
                    break;
            }
        }
        function KeyUp(e){
            switch(e.keyCode){
                case 39:
                    right = false;
                    break;
                case 37:
                    left = false;
                    break;
                case 38:
                    up = false;
                    break;
                case 40:
                    down = false;
                    break;
            }
        }
        function Update(){
            if(up&&down)
                vAxis = 0;
            else if(up)
                vAxis = 1;
            else if (down)
                vAxis = -1;
            else
                vAxis = 0;
            if(right&&left)
                hAxis = 0;
            else if(right)
                hAxis = 1;
            else if (left)
                hAxis = -1;
            else
                hAxis = 0;
            ch.x += hAxis * 0.02 * 2;
            ch.y += vAxis * 0.02 * 2;
            if(ch.x < 0)
                ch.x = 0;
            if(ch.y < 0)
                ch.y = 0;
            if(ch.x > 400 / s2p - ch.width)
                ch.x = 400 / s2p - ch.width;
            if(ch.y > 300 / s2p - ch.height)
                ch.y = 300 / s2p - ch.height;
            objList.forEach(obj => {
                obj.color = "#FFFFFF";
            });
            CheckRectCollision(ch).forEach(rect => {
                rect.master.color = "#FF0000";
            });
            ctx.fillStyle = "#000000";
            ctx.fillRect(0,0,400,300);
            objList.forEach(obj=>{
                ctx.fillStyle = obj.color;
                ctx.fillRect(obj.rect.x * s2p, 300 - obj.rect.y * s2p,obj.rect.width * s2p,-obj.rect.height * s2p);
            });
            ctx.fillStyle = "#00FFFF";
            ctx.fillRect(ch.x * s2p,300 - ch.y * s2p,ch.width * s2p,-ch.height * s2p);
        }
        function OnLoad(){
            ctx = document.getElementById("screen").getContext("2d");
            SetGridListSize(16,16);
            SetGridScale(2,2);
            AddRect(new Object(1.4, 1.5, 0.5, 0.6).rect);
            AddRect(new Object(0.2, 0.8, 2, 0.5).rect);
            AddRect(new Object(2.5, 1.8, 1.5, 1.5).rect);
            AddRect(new Object(4.4, 2.7, 2.5, 0.8).rect);
            window.setInterval(Update,20);
        }
        </script>
    </body>
</html>